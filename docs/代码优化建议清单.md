# ä»£ç çº§æ€§èƒ½ä¼˜åŒ–å»ºè®®æ¸…å•

## ğŸ¯ ä¼˜å…ˆçº§è¯´æ˜
- ğŸ”´ **é«˜ä¼˜å…ˆçº§** - ç«‹å³å®æ–½ï¼Œæ˜¾è‘—æ€§èƒ½æå‡
- ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§** - å»ºè®®å®æ–½ï¼Œé€‚åº¦æ€§èƒ½æå‡  
- ğŸŸ¢ **ä½ä¼˜å…ˆçº§** - å¯é€‰å®æ–½ï¼Œç»†èŠ‚ä¼˜åŒ–

---

## 1. æ•°æ®åº“/å­˜å‚¨ä¼˜åŒ–

### ğŸ”´ ä½¿ç”¨MMKVæ›¿ä»£SharedPreferences
**å½±å“æ–‡ä»¶**: `Config.java`, `Status.java`, `DataStore.kt`

**å½“å‰é—®é¢˜**:
- SharedPreferencesåœ¨ä¸»çº¿ç¨‹åŒæ­¥I/O
- é¢‘ç¹è¯»å†™å¯¼è‡´å¡é¡¿

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```kotlin
// å·²ä½¿ç”¨MMKVï¼Œä½†éœ€ç¡®ä¿å¼‚æ­¥å†™å…¥
DataStore.put("key", value, async = true)
```

**é¢„æœŸæ”¶ç›Š**: I/Oæ€§èƒ½æå‡5-10å€

---

### ğŸŸ¡ æ‰¹é‡å†™å…¥ä¼˜åŒ–
**å½±å“æ–‡ä»¶**: `Status.java`

**ä¼˜åŒ–å»ºè®®**:
```java
// ä¼˜åŒ–å‰ï¼šå¤šæ¬¡å•ç‹¬ä¿å­˜
Status.save(userId, "energy", value1);
Status.save(userId, "coins", value2);
Status.save(userId, "items", value3);

// ä¼˜åŒ–åï¼šæ‰¹é‡ä¿å­˜
Status.batchSave(userId, mapOf(
    "energy" to value1,
    "coins" to value2,
    "items" to value3
));
```

---

## 2. ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

### ğŸ”´ å®ç°è¯·æ±‚å»é‡æœºåˆ¶
**å½±å“æ–‡ä»¶**: `NewRpcBridge.java`

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// æ–°å¢è¯·æ±‚å»é‡ç¼“å­˜
private final ConcurrentHashMap<String, RpcEntity> pendingRequests = new ConcurrentHashMap<>();

public RpcEntity requestObject(RpcEntity rpcEntity, int tryCount, int retryInterval) {
    String requestKey = rpcEntity.getRequestMethod() + ":" + rpcEntity.getRequestData().hashCode();
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒè¯·æ±‚æ­£åœ¨è¿›è¡Œ
    RpcEntity pending = pendingRequests.get(requestKey);
    if (pending != null && !pending.isCompleted()) {
        return pending; // å¤ç”¨è¿›è¡Œä¸­çš„è¯·æ±‚
    }
    
    pendingRequests.put(requestKey, rpcEntity);
    try {
        return performRequest(rpcEntity, tryCount, retryInterval);
    } finally {
        pendingRequests.remove(requestKey);
    }
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘10-20%é‡å¤è¯·æ±‚

---

### ğŸŸ¡ HTTPè¿æ¥æ± ä¼˜åŒ–
**å½±å“æ–‡ä»¶**: `NewRpcBridge.java`

**å»ºè®®**:
- å¤ç”¨HTTPè¿æ¥ï¼Œé¿å…é¢‘ç¹å»ºç«‹è¿æ¥
- è®¾ç½®åˆç†çš„è¿æ¥è¶…æ—¶æ—¶é—´
- å®ç°è¿æ¥ä¿æ´»æœºåˆ¶

---

## 3. å†…å­˜ä¼˜åŒ–

### ğŸ”´ å¯¹è±¡æ± æŠ€æœ¯
**å½±å“æ–‡ä»¶**: `AntForest.kt`, `RpcEntity.kt`

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```kotlin
// ä¸ºé¢‘ç¹åˆ›å»ºçš„å¯¹è±¡å®ç°å¯¹è±¡æ± 
object RpcEntityPool {
    private val pool = ArrayDeque<RpcEntity>(32)
    
    fun obtain(): RpcEntity {
        return pool.removeFirstOrNull() ?: RpcEntity()
    }
    
    fun recycle(entity: RpcEntity) {
        entity.reset()
        if (pool.size < 64) {
            pool.addLast(entity)
        }
    }
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘GCå‹åŠ›ï¼Œé™ä½30-40%å¯¹è±¡åˆ†é…

---

### ğŸŸ¡ å¼±å¼•ç”¨ç¼“å­˜
**å½±å“æ–‡ä»¶**: `UserMap.java`, `IdMapManager.java`

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨WeakHashMapå­˜å‚¨ä¸å¸¸ç”¨æ•°æ®
private static final Map<String, WeakReference<UserInfo>> userCache = 
    Collections.synchronizedMap(new WeakHashMap<>());
```

---

## 4. å¹¶å‘ä¼˜åŒ–

### ğŸ”´ å‡å°‘é”äº‰ç”¨
**å½±å“æ–‡ä»¶**: `UserMap.java`, `Files.java`

**å½“å‰é—®é¢˜**:
```java
// è¿‡åº¦ä½¿ç”¨synchronizedå¯¼è‡´çº¿ç¨‹é˜»å¡
public synchronized static void load(String userId) {
    // é•¿æ—¶é—´I/Oæ“ä½œ
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// ä½¿ç”¨è¯»å†™é”ï¼Œå…è®¸å¹¶å‘è¯»å–
private static final ReadWriteLock rwLock = new ReentrantReadWriteLock();

public static void load(String userId) {
    rwLock.writeLock().lock();
    try {
        // I/Oæ“ä½œ
    } finally {
        rwLock.writeLock().unlock();
    }
}

public static String get(String key) {
    rwLock.readLock().lock();
    try {
        return data.get(key);
    } finally {
        rwLock.readLock().unlock();
    }
}
```

**é¢„æœŸæ”¶ç›Š**: å¹¶å‘è¯»å–æ€§èƒ½æå‡3-5å€

---

### ğŸŸ¡ ä½¿ç”¨ConcurrentHashMapæ›¿ä»£åŒæ­¥Map
**å½±å“æ–‡ä»¶**: å¤šä¸ªæ–‡ä»¶

**æŸ¥æ‰¾å¹¶æ›¿æ¢**:
```java
// æ›¿æ¢å‰
Collections.synchronizedMap(new HashMap<>())

// æ›¿æ¢å  
new ConcurrentHashMap<>()
```

---

## 5. ç®—æ³•ä¼˜åŒ–

### ğŸ”´ èƒ½é‡æ”¶é›†æ’åºä¼˜åŒ–
**å½±å“æ–‡ä»¶**: `AntForest.kt`

**å½“å‰é—®é¢˜**: æ¯æ¬¡éƒ½å¯¹å…¨éƒ¨å¥½å‹æ’åº

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```kotlin
// ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—ï¼Œä»…ç»´æŠ¤Top-N
private val topEnergyUsers = PriorityQueue<UserEnergy>(100) { a, b ->
    b.predictedEnergy.compareTo(a.predictedEnergy)
}

fun addUser(userId: String, energy: Int) {
    if (topEnergyUsers.size < 100 || energy > topEnergyUsers.peek().energy) {
        topEnergyUsers.offer(UserEnergy(userId, energy))
        if (topEnergyUsers.size > 100) {
            topEnergyUsers.poll()
        }
    }
}
```

**é¢„æœŸæ”¶ç›Š**: å¤§æ•°æ®é›†æ’åºæ€§èƒ½æå‡50-70%

---

### ğŸŸ¡ JSONè§£æä¼˜åŒ–
**å½±å“æ–‡ä»¶**: `JsonUtil.java`

**å»ºè®®**:
```java
// ä½¿ç”¨æµå¼è§£ææ›¿ä»£DOMè§£æï¼ˆå¤§JSONæ—¶ï¼‰
JsonReader reader = new JsonReader(new StringReader(jsonString));
reader.setLenient(true);
// é€ä¸ªè§£æï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§å¯¹è±¡
```

---

## 6. UI/æ—¥å¿—ä¼˜åŒ–

### ğŸŸ¡ å¼‚æ­¥æ—¥å¿—å†™å…¥
**å½±å“æ–‡ä»¶**: `Log.java`, `Logback.java`

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// æ—¥å¿—å†™å…¥ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± 
private static final ExecutorService logExecutor = 
    Executors.newSingleThreadExecutor(r -> {
        Thread t = new Thread(r, "LogWriter");
        t.setPriority(Thread.MIN_PRIORITY);
        return t;
    });

public static void record(String tag, String message) {
    logExecutor.execute(() -> {
        // å¼‚æ­¥å†™å…¥æ–‡ä»¶
        writeToFile(tag, message);
    });
}
```

---

### ğŸŸ¢ å‡å°‘æ—¥å¿—è¾“å‡º
**å…¨å±€ä¼˜åŒ–**:

**å»ºè®®**:
- ç”Ÿäº§ç¯å¢ƒå…³é—­DEBUGçº§åˆ«æ—¥å¿—
- ä½¿ç”¨æ¡ä»¶ç¼–è¯‘`if (BuildConfig.DEBUG)`
- é¿å…åœ¨å¾ªç¯ä¸­æ‰“å°æ—¥å¿—

---

## 7. ç‰¹å®šåœºæ™¯ä¼˜åŒ–

### ğŸ”´ èƒ½é‡é›¨æ”¶é›†ä¼˜åŒ–
**å½±å“æ–‡ä»¶**: `EnergyRainCoroutine.kt`

**ä¼˜åŒ–å»ºè®®**:
```kotlin
// ä½¿ç”¨åç¨‹å¹¶å‘æ”¶é›†ï¼Œè€Œéé¡ºåºæ”¶é›†
suspend fun collectEnergyRainConcurrent(bubbles: List<Bubble>) = coroutineScope {
    bubbles.map { bubble ->
        async(Dispatchers.IO) {
            collectBubble(bubble)
        }
    }.awaitAll()
}
```

**é¢„æœŸæ”¶ç›Š**: èƒ½é‡é›¨æ”¶é›†é€Ÿåº¦æå‡3-5å€

---

### ğŸŸ¡ å¥½å‹åˆ—è¡¨ç¼“å­˜ä¼˜åŒ–
**å½±å“æ–‡ä»¶**: `AntForest.kt`

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```kotlin
// å¢é‡æ›´æ–°å¥½å‹åˆ—è¡¨ï¼Œè€Œéæ¯æ¬¡å…¨é‡è·å–
private var lastFriendListUpdate = 0L
private val cachedFriendList = ConcurrentHashMap<String, FriendInfo>()

fun getFriendList(): List<FriendInfo> {
    val now = System.currentTimeMillis()
    if (now - lastFriendListUpdate > 5 * 60 * 1000) { // 5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
        updateFriendList()
        lastFriendListUpdate = now
    }
    return cachedFriendList.values.toList()
}
```

---

## 8. åç¨‹ä¼˜åŒ–

### ğŸŸ¡ ä½¿ç”¨ç»“æ„åŒ–å¹¶å‘
**å½±å“æ–‡ä»¶**: `AntForest.kt`, `ModelTask.kt`

**ä¼˜åŒ–å»ºè®®**:
```kotlin
// ä½¿ç”¨supervisorScopeå¤„ç†ç‹¬ç«‹ä»»åŠ¡
supervisorScope {
    friends.forEach { friend ->
        launch {
            try {
                collectEnergy(friend)
            } catch (e: Exception) {
                // å•ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
                Log.error(TAG, "æ”¶é›†${friend.name}èƒ½é‡å¤±è´¥", e)
            }
        }
    }
}
```

---

### ğŸŸ¡ åˆç†ä½¿ç”¨Dispatchers
**å…¨å±€ä¼˜åŒ–**:

**å»ºè®®**:
```kotlin
// IOå¯†é›†ä»»åŠ¡
launch(Dispatchers.IO) { }

// CPUå¯†é›†ä»»åŠ¡
launch(Dispatchers.Default) { }

// UIæ“ä½œï¼ˆå¦‚æœæœ‰ï¼‰
launch(Dispatchers.Main) { }

// è‡ªå®šä¹‰è°ƒåº¦å™¨ï¼ˆå·²ä¼˜åŒ–ï¼‰
launch(GlobalThreadPools.computeDispatcher) { }
```

---

## 9. ç”µæ± ä¼˜åŒ–

### ğŸŸ¡ æ™ºèƒ½å”¤é†’ç­–ç•¥
**å½±å“æ–‡ä»¶**: `AlarmScheduler.kt`, `ApplicationHook.java`

**ä¼˜åŒ–å»ºè®®**:
```kotlin
// é¿å…é¢‘ç¹å”¤é†’ï¼Œåˆå¹¶å”¤é†’æ—¶æœº
fun scheduleSmartWakeup(tasks: List<Task>) {
    val groupedTasks = tasks.groupBy { 
        // å°†æ—¶é—´æ¥è¿‘çš„ä»»åŠ¡åˆ†ç»„ï¼ˆ15åˆ†é’Ÿçª—å£ï¼‰
        it.scheduledTime / (15 * 60 * 1000)
    }
    
    groupedTasks.forEach { (window, tasksInWindow) ->
        // ä¸€æ¬¡å”¤é†’æ‰§è¡Œå¤šä¸ªä»»åŠ¡
        scheduleAlarm(window * 15 * 60 * 1000, tasksInWindow)
    }
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘20-30%å”¤é†’æ¬¡æ•°

---

### ğŸŸ¢ JobScheduleræ›¿ä»£AlarmManager
**å½±å“æ–‡ä»¶**: `AlarmScheduler.kt`

**å»ºè®®** (Android 5.0+):
```kotlin
// ä½¿ç”¨JobSchedulerè¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼ˆæ›´çœç”µï¼‰
val jobScheduler = context.getSystemService(Context.JOB_SCHEDULER_SERVICE) as JobScheduler
val jobInfo = JobInfo.Builder(JOB_ID, componentName)
    .setPeriodic(15 * 60 * 1000) // 15åˆ†é’Ÿ
    .setRequiredNetworkType(JobInfo.NETWORK_TYPE_ANY)
    .setPersisted(true)
    .build()
jobScheduler.schedule(jobInfo)
```

---

## 10. ç½‘ç»œæµé‡ä¼˜åŒ–

### ğŸŸ¡ æ•°æ®å‹ç¼©
**å½±å“æ–‡ä»¶**: `NewRpcBridge.java`

**å»ºè®®**:
```java
// è¯·æ±‚/å“åº”å¯ç”¨GZIPå‹ç¼©
request.addHeader("Accept-Encoding", "gzip, deflate");
```

---

### ğŸŸ¡ å¢é‡æ•°æ®åŒæ­¥
**å½±å“æ–‡ä»¶**: `Status.java`

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// ä»…åŒæ­¥å˜æ›´çš„æ•°æ®ï¼Œè€Œéå…¨é‡
public static void syncChanges() {
    Map<String, Object> changes = getChangedData();
    if (!changes.isEmpty()) {
        uploadChanges(changes);
        markAsSynced();
    }
}
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„æµ‹

| ä¼˜åŒ–é¡¹ | éš¾åº¦ | é¢„æœŸæ€§èƒ½æå‡ | å®æ–½ä¼˜å…ˆçº§ |
|-------|-----|------------|-----------|
| RPCå»é‡æœºåˆ¶ | ä¸­ | 10-20% | ğŸ”´ é«˜ |
| å¯¹è±¡æ± æŠ€æœ¯ | ä¸­ | 15-25% | ğŸ”´ é«˜ |
| è¯»å†™é”ä¼˜åŒ– | ä½ | 20-30% | ğŸ”´ é«˜ |
| èƒ½é‡é›¨å¹¶å‘ | ä½ | 200-400% | ğŸ”´ é«˜ |
| å¼‚æ­¥æ—¥å¿— | ä½ | 5-10% | ğŸŸ¡ ä¸­ |
| å¥½å‹åˆ—è¡¨ç¼“å­˜ | ä½ | 10-15% | ğŸŸ¡ ä¸­ |
| JobScheduler | ä¸­ | 20-30%ç”µé‡ | ğŸŸ¢ ä½ |

---

## ğŸ› ï¸ å®æ–½æ­¥éª¤å»ºè®®

### ç¬¬ä¸€é˜¶æ®µ (1-2å¤©)
1. âœ… RPCæŒ‡æ•°é€€é¿ï¼ˆå·²å®Œæˆï¼‰
2. âœ… å¹¶å‘æ•°ä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰
3. âœ… é”ä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰
4. âœ… æ™ºèƒ½ç¼“å­˜ï¼ˆå·²å®Œæˆï¼‰

### ç¬¬äºŒé˜¶æ®µ (3-5å¤©)
1. â¬œ RPCè¯·æ±‚å»é‡
2. â¬œ å¯¹è±¡æ± å®ç°
3. â¬œ è¯»å†™é”æ›¿æ¢
4. â¬œ èƒ½é‡é›¨å¹¶å‘ä¼˜åŒ–

### ç¬¬ä¸‰é˜¶æ®µ (1å‘¨)
1. â¬œ å¼‚æ­¥æ—¥å¿—ä¼˜åŒ–
2. â¬œ å¥½å‹åˆ—è¡¨å¢é‡æ›´æ–°
3. â¬œ å†…å­˜ä¼˜åŒ–ï¼ˆå¼±å¼•ç”¨ï¼‰
4. â¬œ ç”µæ± ä¼˜åŒ–

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æµ‹è¯•è¦†ç›–**: æ¯é¡¹ä¼˜åŒ–åéœ€å……åˆ†æµ‹è¯•ï¼Œé¿å…å¼•å…¥Bug
2. **ç‰ˆæœ¬å…¼å®¹**: ç¡®ä¿ä¼˜åŒ–å…¼å®¹ä¸åŒAndroidç‰ˆæœ¬
3. **æ€§èƒ½ç›‘æ§**: ä½¿ç”¨Profilerç›‘æ§ä¼˜åŒ–æ•ˆæœ
4. **æ¸è¿›å¼ä¼˜åŒ–**: ä¸€æ¬¡å®æ–½1-2é¡¹ä¼˜åŒ–ï¼Œè§‚å¯Ÿæ•ˆæœåå†ç»§ç»­

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**ç»´æŠ¤è€…**: Performance Team
