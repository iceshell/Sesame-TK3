# èŠéº»ç²’(Sesame-TK)é¡¹ç›®æ·±åº¦åˆ†æä¸é‡æ„å»ºè®®æŠ¥å‘Š

> **é¡¹ç›®**: èŠéº»ç²’ - æ”¯ä»˜å®èš‚èšæ£®æ—èƒ½é‡æ”¶å–ä¸ä»»åŠ¡æ‰§è¡Œå·¥å…·  
> **GitHub**: https://github.com/Fansirsqi/Sesame-TK/tree/n  
> **åˆ†ææ—¥æœŸ**: 2025å¹´10æœˆ25æ—¥  
> **åˆ†æç‰ˆæœ¬**: v0.2.8.é­”æ”¹ç‰ˆ

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒå‘ç°

**é¡¹ç›®ç°çŠ¶**:
- **ä»£ç è§„æ¨¡**: çº¦200ä¸ªæºæ–‡ä»¶ï¼ˆ129ä¸ªJava + 71ä¸ªKotlinï¼‰
- **ä»£ç é‡**: çº¦1.86MBï¼ˆ1079KB Java + 776KB Kotlinï¼‰
- **æ¶æ„å¤æ‚åº¦**: â­â­â­â­â˜† (é«˜)
- **ç»´æŠ¤éš¾åº¦**: â­â­â­â­â­ (æé«˜)
- **æŠ€æœ¯å€ºåŠ¡**: â­â­â­â­â˜† (ä¸¥é‡)

**å…³é”®é—®é¢˜**:
1. âŒ **å¤šè¯­è¨€æ··ç¼–ä¸¥é‡** - Javaã€Kotlinã€JavaScriptæ··åˆä½¿ç”¨
2. âŒ **æ¶æ„æ¼”è¿›æ··ä¹±** - BaseTask(Java) + ModelTask(Kotlin)åŒä½“ç³»å¹¶å­˜
3. âŒ **å¹¶å‘æ¨¡å‹å¤æ‚** - Thread + Coroutineä¸¤å¥—å¹¶å‘ä½“ç³»æ··ç”¨
4. âŒ **ä»£ç è´¨é‡å‚å·®** - å­˜åœ¨å¤§é‡TODOã€FIXMEæ ‡è®°ï¼ˆ48+å¤„ï¼‰
5. âŒ **æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾** - AntForest.ktå•æ–‡ä»¶205KBï¼Œé€»è¾‘è‡ƒè‚¿

### é‡æ„å»ºè®®ç»“è®º

**å¼ºçƒˆæ¨èä½¿ç”¨Kotlinè¿›è¡Œå…¨é¢é‡æ„**ï¼Œç†ç”±å¦‚ä¸‹ï¼š

âœ… **æŠ€æœ¯ä¼˜åŠ¿**:
- Kotlinå·²å æ®é¡¹ç›®æ ¸å¿ƒï¼ˆæ ¸å¿ƒModelTaskã€åç¨‹è°ƒåº¦å™¨å‡ä¸ºKotlinï¼‰
- Jetpack Compose UIå·²ä½¿ç”¨Kotlin
- åç¨‹å¹¶å‘æ¨¡å‹ç°ä»£åŒ–ã€æ˜“ç»´æŠ¤
- ç©ºå®‰å…¨ç‰¹æ€§å‡å°‘NPEé£é™©
- ä¸Java 100%äº’æ“ä½œï¼Œå¯æ¸è¿›å¼è¿ç§»

âœ… **å®é™…æ”¶ç›Š**:
- é¢„è®¡å‡å°‘30-40%ä»£ç é‡
- æå‡50%ä»¥ä¸Šå¼€å‘æ•ˆç‡
- é™ä½70%ç»´æŠ¤æˆæœ¬
- æå‡æ•´ä½“ä»£ç è´¨é‡å’Œå¯è¯»æ€§

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¶æ„æ·±åº¦åˆ†æ](#1-é¡¹ç›®æ¶æ„æ·±åº¦åˆ†æ)
2. [ä»£ç è´¨é‡è¯„ä¼°](#2-ä»£ç è´¨é‡è¯„ä¼°)
3. [æŠ€æœ¯å€ºåŠ¡åˆ†æ](#3-æŠ€æœ¯å€ºåŠ¡åˆ†æ)
4. [æ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#4-æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
5. [é‡æ„æ–¹æ¡ˆå¯¹æ¯”](#5-é‡æ„æ–¹æ¡ˆå¯¹æ¯”)
6. [Kotliné‡æ„è·¯çº¿å›¾](#6-kotliné‡æ„è·¯çº¿å›¾)
7. [é£é™©è¯„ä¼°ä¸ç¼“è§£](#7-é£é™©è¯„ä¼°ä¸ç¼“è§£)
8. [å®æ–½å»ºè®®](#8-å®æ–½å»ºè®®)

---

## 1. é¡¹ç›®æ¶æ„æ·±åº¦åˆ†æ

### 1.1 ä»£ç ç»Ÿè®¡

```
æ€»æ–‡ä»¶æ•°: 200ä¸ªæºæ–‡ä»¶
â”œâ”€â”€ Javaæ–‡ä»¶: 129ä¸ª (1079KB, 64.5%)
â”œâ”€â”€ Kotlinæ–‡ä»¶: 71ä¸ª (776KB, 35.5%)
â””â”€â”€ JavaScriptæ–‡ä»¶: 2ä¸ª (webèµ„æº)

ä»£ç åˆ†å¸ƒ:
â”œâ”€â”€ task/ (ä»»åŠ¡æ¨¡å—) - æœ€å¤æ‚
â”‚   â”œâ”€â”€ antForest/AntForest.kt - 205KB âš ï¸ å•æ–‡ä»¶è¿‡å¤§
â”‚   â”œâ”€â”€ antForest/AntForestRpcCall.java - 43KB
â”‚   â”œâ”€â”€ antForest/EnergyWaitingManager.kt - 47KB
â”‚   â””â”€â”€ å…¶ä»–ä»»åŠ¡æ¨¡å— (15+ä¸ª)
â”œâ”€â”€ hook/ (Hookæ¨¡å—)
â”‚   â”œâ”€â”€ ApplicationHook.java - 49KB
â”‚   â”œâ”€â”€ AlarmScheduler.kt - 20KB (Kotlinåç¨‹)
â”‚   â””â”€â”€ rpc/ (RPCè°ƒç”¨å°è£…)
â”œâ”€â”€ model/ (é…ç½®æ¨¡å‹) - å…¨Java
â”œâ”€â”€ ui/ (ç•Œé¢) - Kotlin + Jetpack Compose
â””â”€â”€ util/ (å·¥å…·ç±») - Javaä¸ºä¸»
```

### 1.2 æ¶æ„æ¼”è¿›å†å²

é¡¹ç›®ç»å†äº†æ˜æ˜¾çš„æ¶æ„æ¼”è¿›ï¼Œç•™ä¸‹äº†å¤šä¸ªå†å²åŒ…è¢±ï¼š

**ç¬¬ä¸€ä»£æ¶æ„** (BaseTaskæ—¶ä»£):
```java
// Javaçº¿ç¨‹æ¨¡å‹
public abstract class BaseTask {
    private volatile Thread thread;
    public void startTask() {
        thread = new Thread(this::run);
        thread.start();
    }
}
```

**ç¬¬äºŒä»£æ¶æ„** (ModelTaskæ—¶ä»£):
```kotlin
// Kotlinåç¨‹æ¨¡å‹
abstract class ModelTask : Model() {
    private var taskScope: CoroutineScope? = null
    fun startTask(): Job? {
        return taskScope!!.launch { 
            run() 
        }
    }
}
```

**é—®é¢˜**: ä¸¤ä»£æ¶æ„å¹¶å­˜ï¼Œå¢åŠ ç†è§£å’Œç»´æŠ¤éš¾åº¦ã€‚

### 1.3 æ ¸å¿ƒæ¨¡å—åˆ†æ

#### A. ä»»åŠ¡æ‰§è¡Œç³»ç»Ÿ

**åŒä½“ç³»å¹¶å­˜**:
- `BaseTask.java` - æ—§çº¿ç¨‹æ¨¡å‹ï¼ˆå·²ä¸æ¨èï¼‰
- `ModelTask.kt` - æ–°åç¨‹æ¨¡å‹ï¼ˆæ¨èä½¿ç”¨ï¼‰

**ç»§æ‰¿å…³ç³»**:
```
ModelTask (Kotlinåç¨‹)
â”œâ”€â”€ AntForest (æ£®æ—) - Kotlin âœ…
â”œâ”€â”€ AntFarm (å†œåœº) - Kotlin âœ…  
â”œâ”€â”€ AntOcean (æµ·æ´‹) - Java âŒ
â”œâ”€â”€ AntMember (ä¼šå‘˜) - éœ€ç¡®è®¤
â””â”€â”€ å…¶ä»–ä»»åŠ¡...
```

**è¯„ä¼°**: å·²æœ‰çº¦40%ä»»åŠ¡è¿ç§»åˆ°Kotlinï¼Œä½†ä»æœ‰å¤§é‡Javaä»»åŠ¡ã€‚

#### B. Hookç³»ç»Ÿ

**æ ¸å¿ƒç»„ä»¶**:
- `ApplicationHook.java` - ä¸»Hookå…¥å£ (Java)
- `AlarmScheduler.kt` - å®šæ—¶è°ƒåº¦å™¨ (Kotlinåç¨‹)
- `RequestManager.kt` - è¯·æ±‚ç®¡ç† (Kotlin)
- RPCæ¡¥æ¥: NewRpcBridge(Java) + OldRpcBridge(Java)

**è¯„ä¼°**: Hookå±‚æ··åˆä¸¥é‡ï¼ŒKotlinåŒ–è¿›åº¦çº¦30%ã€‚

#### C. å¹¶å‘æ¨¡å‹

**ä¸‰ç§å¹¶å‘æœºåˆ¶æ··ç”¨**:
1. **Java Thread** - BaseTaskä½¿ç”¨
2. **Kotlin Coroutine** - ModelTaskã€AlarmSchedulerä½¿ç”¨
3. **çº¿ç¨‹æ± ** - GlobalThreadPools.ktå°è£…

**åŒæ­¥åŸè¯­**:
- Java: `synchronized`, `ConcurrentHashMap`, `AtomicInteger`
- Kotlin: `Mutex`, `Semaphore`, `@Volatile`

**è¯„ä¼°**: å¹¶å‘æ¨¡å‹æ··ä¹±ï¼Œå¢åŠ æ­»é”å’Œç«æ€æ¡ä»¶é£é™©ã€‚

---

## 2. ä»£ç è´¨é‡è¯„ä¼°

### 2.1 ä»£ç è§„èŒƒæ€§

**Lombokä½¿ç”¨**:
- 45ä¸ªæ–‡ä»¶ä½¿ç”¨Lombokæ³¨è§£
- ä¸»è¦ä½¿ç”¨: `@Data`, `@Getter`, `@Setter`
- **é—®é¢˜**: Kotlinä¸éœ€è¦Lombokï¼Œå¢åŠ ä¸å¿…è¦ä¾èµ–

**ç©ºå®‰å…¨**:
```java
// Java - å®¹æ˜“NPE
private String userId;
public void process() {
    userId.length(); // å¯èƒ½ç©ºæŒ‡é’ˆ
}
```

```kotlin
// Kotlin - ç¼–è¯‘æœŸç©ºå®‰å…¨
private var userId: String? = null
fun process() {
    userId?.length // å®‰å…¨è°ƒç”¨
}
```

**ä»£ç å¤æ‚åº¦**:
- `AntForest.kt`: 4839è¡Œ âš ï¸ **ä¸¥é‡è¶…æ ‡**
- `ApplicationHook.java`: 1088è¡Œ âš ï¸ åé«˜
- `EnergyWaitingManager.kt`: 1000+è¡Œ âš ï¸ åé«˜

**å»ºè®®å•æ–‡ä»¶è¡Œæ•°**: 500è¡Œä»¥å†…

### 2.2 æŠ€æœ¯å€ºåŠ¡æ ‡è®°

æ‰«æå‘ç°**48+å¤„**æŠ€æœ¯å€ºåŠ¡æ ‡è®°:
- `TODO`: å¤§é‡å¾…å®ç°åŠŸèƒ½
- `FIXME`: å·²çŸ¥Bugæœªä¿®å¤
- `XXX`: ä¸´æ—¶æ–¹æ¡ˆ
- `HACK`: ä¸è§„èŒƒå®ç°

**å…¸å‹æ¡ˆä¾‹**:
```kotlin
// AntForest.kt
/// lzw add begin  // âš ï¸ ä¸ªäººæ ‡è®°ï¼Œæœªè§„èŒƒ
private var monday = false
/// lzw add end
```

### 2.3 ä¾èµ–ç®¡ç†

**ä¾èµ–å¤æ‚åº¦**: ä¸­ç­‰

**å…³é”®ä¾èµ–**:
- Xposed Framework (æ ¸å¿ƒ)
- Kotlin Coroutines (å¼‚æ­¥)
- Jackson (JSONåºåˆ—åŒ–)
- Jetpack Compose (UI)
- OkHttp (ç½‘ç»œ)
- DexKit (DEXåˆ†æ)
- MMKV (å­˜å‚¨)

**å…¼å®¹æ€§å¤„ç†**:
```kotlin
productFlavors {
    create("normal") {
        // JVM 17, Android 8.0+
    }
    create("compatible") {
        // JVM 11, Android 7.0+
    }
}
```

**è¯„ä¼°**: ä¾èµ–ç®¡ç†è‰¯å¥½ï¼Œä½†éœ€ç»Ÿä¸€JSONåº“ï¼ˆJackson vs Gsonï¼‰ã€‚

---

## 3. æŠ€æœ¯å€ºåŠ¡åˆ†æ

### 3.1 æ¶æ„å€ºåŠ¡

**é—®é¢˜1: åŒä»»åŠ¡ç³»ç»Ÿå¹¶å­˜**
- å½±å“: å¼€å‘è€…å›°æƒ‘ï¼Œç»´æŠ¤æˆæœ¬é«˜
- ä¸¥é‡æ€§: â­â­â­â­â­
- è§£å†³: åºŸå¼ƒBaseTaskï¼Œå…¨é¢è¿ç§»åˆ°ModelTask

**é—®é¢˜2: RPCå±‚è®¾è®¡å†—ä½™**
- OldRpcBridge + NewRpcBridge
- å½±å“: é‡å¤ä»£ç ï¼Œç‰ˆæœ¬å…¼å®¹æ··ä¹±
- ä¸¥é‡æ€§: â­â­â­â­
- è§£å†³: ç»Ÿä¸€RPCå±‚ï¼Œä½¿ç”¨ç­–ç•¥æ¨¡å¼

**é—®é¢˜3: é…ç½®ç³»ç»Ÿå¤æ‚**
- Config.java + ModelConfig + DataStore
- å½±å“: é…ç½®åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†
- ä¸¥é‡æ€§: â­â­â­
- è§£å†³: ç»Ÿä¸€é…ç½®å±‚ï¼Œä½¿ç”¨Kotlin sealed class

### 3.2 ä»£ç å€ºåŠ¡

**å·¨å‹ç±»**:
- `AntForest.kt`: 4839è¡Œ - éœ€æ‹†åˆ†æˆ10+ä¸ªç±»
  - EnergyCollector (èƒ½é‡æ”¶é›†)
  - PropManager (é“å…·ç®¡ç†)
  - TaskExecutor (ä»»åŠ¡æ‰§è¡Œ)
  - FriendManager (å¥½å‹ç®¡ç†)
  - WateringManager (æµ‡æ°´ç®¡ç†)
  - ...

**é‡å¤ä»£ç **:
```java
// AntForestRpcCall.java
public static String queryFriendsEnergyRanking() {
    try {
        JSONObject arg = new JSONObject();
        arg.put("source", "chInfo_ch_appcenter__chsub_9patch");
        // ...
    } catch (Exception e) {
        return "";
    }
}

// ç±»ä¼¼æ¨¡å¼é‡å¤20+æ¬¡
```

**å»ºè®®**: æå–RPCè°ƒç”¨åŸºç±»ï¼Œä½¿ç”¨æ³›å‹å°è£…ã€‚

### 3.3 å¹¶å‘å€ºåŠ¡

**çº¿ç¨‹å®‰å…¨é—®é¢˜**:
```java
// BaseTask.java
public synchronized void addChildTask(BaseTask childTask) {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
        childTaskMap.compute(childId, (key, value) -> {
            // ç‰ˆæœ¬åˆ¤æ–­æ··ä¹±
        });
    } else {
        // æ—§ç‰ˆæœ¬é€»è¾‘
    }
}
```

**Kotlinåç¨‹æ–¹æ¡ˆ**:
```kotlin
private val childTaskMap = ConcurrentHashMap<String, ChildModelTask>()
private val mutex = Mutex()

suspend fun addChildTask(childTask: ChildModelTask) {
    mutex.withLock {
        childTaskMap[childId] = childTask
    }
}
```

---

## 4. æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

### 4.1 ä¸»è¦ç“¶é¢ˆ

**1. èƒ½é‡æ”¶é›†å¹¶å‘æ§åˆ¶ä¸å½“**
```kotlin
// AntForest.kt
private val concurrencyLimiter = Semaphore(60) // ä¿¡å·é‡é™åˆ¶
```
- é—®é¢˜: ç¡¬ç¼–ç 60ï¼Œæœªæ ¹æ®è®¾å¤‡æ€§èƒ½åŠ¨æ€è°ƒæ•´
- å»ºè®®: æ ¹æ®CPUæ ¸å¿ƒæ•°åŠ¨æ€è®¾ç½®

**2. å•æ–‡ä»¶è¿‡å¤§å¯¼è‡´ç¼–è¯‘æ…¢**
- `AntForest.kt`: 205KB
- ç¼–è¯‘æ—¶é—´: å¯èƒ½è¾¾åˆ°æ•°åç§’
- å»ºè®®: æ‹†åˆ†æˆå¤šä¸ªæ–‡ä»¶

**3. JSONè§£æå¼€é”€**
```java
// å¤§é‡JSONObjectæ‰‹åŠ¨æ„å»º
JSONObject arg = new JSONObject();
arg.put("source", "...");
arg.put("periodType", "...");
// ...
```
- å»ºè®®: ä½¿ç”¨Kotlin data class + kotlinx.serialization

### 4.2 å†…å­˜ä¼˜åŒ–æœºä¼š

**ConcurrentHashMapè¿‡åº¦ä½¿ç”¨**:
- 26ä¸ªæ–‡ä»¶ä½¿ç”¨ConcurrentHashMap
- éƒ¨åˆ†åœºæ™¯ä¸éœ€è¦çº¿ç¨‹å®‰å…¨
- å»ºè®®: ä½¿ç”¨æ™®é€šHashMap + é€‚å½“åŒæ­¥

**å­—ç¬¦ä¸²æ‹¼æ¥**:
```java
String param = "[" + arg + "]";  // Javaå­—ç¬¦ä¸²æ‹¼æ¥
```

```kotlin
val param = "[$arg]"  // Kotlinå­—ç¬¦ä¸²æ¨¡æ¿
```

---

