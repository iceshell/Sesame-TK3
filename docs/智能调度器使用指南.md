# 智能调度器使用指南 🚀

## 📌 快速开始

### 自动生效（无需配置）

所有优化已集成到代码中，**重启支付宝后自动生效**：

```
1. 完全重启支付宝应用
2. 等待芝麻粒模块加载
3. 查看日志确认组件启动
```

---

## 🕐 定时启动时间表

### 每日自动启动时间

```
📅 早上: 06:58 启动
    ↓
    07:00-08:00 能量收集高峰期
    ↓
    每10分钟检查支付宝运行状态

📅 中午: 11:58 启动
    ↓
    12:00-13:00 能量收集高峰期
    ↓
    每10分钟检查支付宝运行状态

📅 傍晚: 16:58 启动
    ↓
    17:00-18:00 能量收集高峰期
    ↓
    每10分钟检查支付宝运行状态
```

### 非高峰时段

```
其他时间: 待机模式
  - 不主动唤醒
  - 低功耗运行
  - 按需执行任务
```

---

## 🔍 功能验证

### 1. 查看启动日志

重启支付宝后，在日志中搜索：

```
关键词: "智能调度器"

期望输出:
[ApplicationHook] 🚀 启动智能调度器（替代Alarm唤醒）
[SmartScheduler] 🚀 启动智能定时调度器（不使用Alarm）
[SmartScheduler] ✅ 智能调度器已启动，定时启动时间: 06:58, 11:58, 16:58
```

### 2. 查看版本信息

搜索日志关键词：`版本信息`

```
期望输出:
═══════════════ 版本信息 ═══════════════
📦 芝麻粒版本: x.x.x
🏗️ 构建类型: release
⏰ 构建时间: 2025-10-18 09:00
💰 支付宝版本: 10.6.58 (xxx)
🤖 Android版本: xx (API xx)
📱 设备型号: xxx
═══════════════════════════════════════
✅ 版本兼容性检查通过
```

### 3. 确认Alarm已禁用

搜索日志：**不应该**看到：

```
❌ 不应出现:
"setAlarmClock"
"闹钟唤醒"
"AlarmManager"
```

应该看到：

```
✅ 应该出现:
"替代Alarm唤醒"
"智能调度器"
"不使用Alarm"
```

---

## 📊 监控和诊断

### 方式1: 日志关键词搜索

| 功能 | 搜索关键词 | 正常输出 |
|-----|----------|---------|
| 调度器状态 | `智能调度器状态` | "运行中" |
| 高峰期检测 | `能量收集高峰期` | 高峰时段显示 |
| 进程监控 | `支付宝运行` | "正常" 或 "重启" |
| 任务健康 | `任务健康` | "正常" 无假死 |
| 版本信息 | `版本信息` | 完整版本输出 |

### 方式2: 检查定时启动

```
早上06:58后检查日志:
  ✓ 应该看到 "到达定时启动时间: 06:58"
  ✓ 应该看到 "已触发能量收集任务"

07:00-08:00期间:
  ✓ 应该看到 "当前处于能量收集高峰期"
  ✓ 每10分钟看到进程检查日志
```

### 方式3: 手动触发测试

如需立即测试，可手动触发能量收集：
```
芝麻粒UI → 立即执行
```

---

## 🛠️ 常见问题排查

### Q1: 定时启动不工作

**症状**: 到了06:58没有自动启动

**排查步骤**:
1. 检查支付宝是否被系统杀死
   - 设置 → 电池 → 支付宝 → 无限制
   
2. 检查芝麻粒模块是否正常加载
   - 查看日志 "芝麻粒-TK 开始初始化"
   
3. 检查智能调度器是否启动
   - 搜索日志 "智能调度器已启动"

**解决方案**:
```
1. 确保支付宝在后台保活
2. 重启支付宝
3. 查看日志确认组件启动
```

---

### Q2: 支付宝频繁重启

**症状**: 日志显示频繁重启支付宝

**可能原因**:
- 支付宝本身不稳定
- RPC通信异常
- 设备资源不足

**查看日志**:
```
搜索: "检测到支付宝未运行"
或
搜索: "支付宝通信异常"
```

**解决方案**:
```
1. 检查支付宝版本（建议10.6.0+）
2. 检查网络连接
3. 清理支付宝缓存
4. 如果频繁重启，可能需要调整检查间隔
```

---

### Q3: 任务假死

**症状**: 任务长时间无响应

**自动处理**: 
```
✓ 5分钟无响应 → 自动检测
✓ 标记为假死 → 记录日志
✓ 自动重启任务 → 恢复运行
```

**查看日志**:
```
搜索: "检测到任务假死"

输出:
[TaskHealthMonitor] 🚨 检测到任务假死: AntForestTask
[TaskHealthMonitor]    - 开始时间: xxx
[TaskHealthMonitor]    - 最后活跃: xxx
[TaskHealthMonitor] 🔄 尝试重启假死任务
[TaskHealthMonitor] ✅ 任务重启命令已发送
```

---

### Q4: 版本信息显示"未知"

**症状**: 版本信息中显示"未知"或"获取失败"

**排查**:
```
1. 检查Context是否为空
   - 日志: "Context为空"
   
2. 检查支付宝是否正常安装
   - 日志: "未安装"
   
3. 检查权限
   - 日志: "获取失败" + 错误信息
```

**解决方案**:
```
1. 确保支付宝正常安装
2. 重启芝麻粒模块
3. 查看详细错误日志
```

---

## ⚙️ 高级配置（可选）

### 自定义定时启动时间

如需修改启动时间，编辑 `SmartScheduler.kt`:

```kotlin
private val STARTUP_TIMES = listOf(
    "06:58",  // 可修改
    "11:58",  // 可修改
    "16:58"   // 可修改
)
```

### 自定义高峰时段

```kotlin
private val PEAK_PERIODS = listOf(
    PeakPeriod(7, 0, 8, 0),    // 07:00-08:00
    PeakPeriod(12, 0, 13, 0),  // 12:00-13:00
    PeakPeriod(17, 0, 18, 0)   // 17:00-18:00
)
```

### 自定义检查间隔

```kotlin
// 进程检查间隔（当前10分钟）
private const val PROCESS_CHECK_INTERVAL = 10 * 60 * 1000L
```

### 自定义任务超时时间

```kotlin
// 任务假死超时（当前5分钟）
private const val TASK_TIMEOUT = 5 * 60 * 1000L
```

---

## 📈 性能优化建议

### 低端设备（4核以下）

```
✓ 保持默认配置
✓ 避免同时运行其他重负载应用
✓ 定期清理支付宝缓存
```

### 中端设备（4-6核）

```
✓ 默认配置最佳
✓ 可适当减少检查间隔至8分钟
```

### 高端设备（8核以上）

```
✓ 可减少检查间隔至5分钟
✓ 可增加监控精度
```

---

## 🔄 恢复Alarm方式（不推荐）

如确实需要恢复传统Alarm唤醒：

### 步骤1: 修改代码

编辑 `ApplicationHook.java`:

```java
// 注释掉新代码
// SmartScheduler.INSTANCE.start(appContext);
// TaskHealthMonitor.INSTANCE.startMonitoring();

// 取消注释旧代码
setWakenAtTimeAlarm();
```

### 步骤2: 重新编译

```bash
./gradlew assembleRelease
```

### ⚠️ 警告

```
恢复Alarm方式可能导致:
  - 支付宝运行异常
  - 电池消耗增加
  - 系统限制唤醒
  - 兼容性问题
  
强烈建议使用新的SmartScheduler！
```

---

## 📞 获取帮助

### 查看详细日志

```
路径: /sdcard/Android/data/com.eg.android.AlipayGphone/files/sesame/
文件: runtime.log, record.log
```

### 日志分析工具

```bash
# 筛选智能调度器日志
adb logcat | grep "SmartScheduler"

# 筛选进程监控日志
adb logcat | grep "AlipayProcessMonitor"

# 筛选任务监控日志
adb logcat | grep "TaskHealthMonitor"
```

### 提交问题

如遇到问题，提供以下信息：

```
1. 设备型号和Android版本
2. 支付宝版本
3. 芝麻粒版本
4. 详细日志（runtime.log）
5. 问题复现步骤
```

---

## ✅ 验收检查清单

部署后请按以下清单验证：

```
□ 支付宝重启后模块正常加载
□ 日志中显示"智能调度器已启动"
□ 日志中显示完整版本信息
□ 日志中不再出现"setAlarmClock"
□ 日志中显示"任务健康监控器已启动"
□ 06:58/11:58/16:58时自动启动
□ 高峰期间显示"能量收集高峰期"
□ 每10分钟出现进程检查日志
□ 支付宝异常时能自动重启
□ 任务假死时能自动恢复
```

---

## 📚 相关文档

- **详细优化报告**: `定时调度与进程监控优化报告.md`
- **全面性能优化**: `全面性能优化完成报告.md`
- **代码优化建议**: `代码优化建议清单.md`
- **快速指南**: `性能优化快速指南.md`

---

**最后更新**: 2025-10-18  
**适用版本**: Sesame-TK n分支及以上  
**状态**: ✅ 生产就绪

**🎉 祝您使用愉快！**
