# Sesame-TK rc142 完整安装清理步骤

## ⚠️ 重要说明
rc142包含了对ClassCastException的最终修复。如果仍然出现问题，说明LSPosed缓存了旧版本代码。

## 📋 完整清理步骤

### 1️⃣ 卸载旧版本
1. 打开**设置** → **应用管理**
2. 找到 **芝麻粒-TK**
3. 点击**卸载**（完全删除）

### 2️⃣ 清理LSPosed缓存（最关键）
**方法一：强制停止支付宝**
1. 打开**设置** → **应用管理** → **支付宝**
2. 点击**强制停止**
3. 返回**LSPosed管理器**
4. 进入**模块** → 找到 **Sesame-TK**
5. 如果显示已启用，先**禁用**模块
6. 等待3秒
7. 重新**启用**模块
8. **重启LSPosed服务**（LSPosed管理器 → 右上角菜单 → 重启）

**方法二：清理缓存数据（推荐）**
1. **LSPosed管理器** → **模块** → **Sesame-TK** → 禁用
2. **设置** → **应用管理** → **支付宝**
   - 点击**存储** → **清除缓存**（不要清除数据）
   - 点击**强制停止**
3. **设置** → **应用管理** → **LSPosed**
   - 点击**存储** → **清除缓存**
   - 点击**强制停止**
4. 返回**LSPosed管理器** → **模块** → **Sesame-TK** → 启用
5. **重启手机**（最彻底）

### 3️⃣ 安装rc142
1. 定位APK文件：`d:\Sesame-TK-n\app\build\outputs\apk\debug\sesame-tk-v0.3.0-rc142-debug.apk`
2. 传输到手机
3. 安装APK

### 4️⃣ 验证安装
1. 打开**LSPosed管理器** → **模块**
2. 确认 **Sesame-TK** 显示为 **已启用**
3. 确认作用域包含 **支付宝**

### 5️⃣ 重启支付宝
1. **完全退出**支付宝（不要只是切换后台）
2. 从最近任务中**划掉**支付宝
3. 等待5秒
4. 重新打开支付宝

### 6️⃣ 测试配置保存
1. 打开支付宝 → **Sesame-TK设置**
2. 选择一个账号
3. 进入**基础菜单**
4. 修改任意**开关**（如"保持唤醒"）
5. 点击**保存**
6. 返回主界面
7. 重新进入设置 → 同一账号 → 基础菜单
8. **检查开关是否保存成功**

## 🔍 验证修复是否生效

### 查看error.log
```bash
# 打开 d:\Sesame-TK-n\log\error.log
# 搜索 "ClassCastException"
# 如果没有，说明修复成功！
```

### 查看runtime.log
```bash
# 打开 d:\Sesame-TK-n\log\runtime.log
# 搜索 "模块版本"
# 应该显示：⚙️模块版本：0.3.0-rc142
```

### 成功标志
- ✅ error.log中**没有**ClassCastException
- ✅ 开关设置能够**正常保存**
- ✅ 数字设置能够**正常保存**
- ✅ 列表选择能够**正常保存**

## ❌ 如果仍然失败

### 症状
- error.log中仍有 `java.lang.Boolean cannot be cast to java.lang.Void`
- runtime.log显示版本是rc142，但仍然报错

### 最终解决方案
1. **完全卸载**支付宝（清除所有数据）
2. **完全卸载**LSPosed
3. **重启手机**
4. 重新安装LSPosed
5. 重新安装支付宝
6. 配置LSPosed作用域
7. 安装Sesame-TK rc142
8. 测试

## 📝 核心修复说明

### 问题根源
在Xposed环境下，泛型类型推断失败，`ModelField<T>`的`valueType`被错误推断为`Void.TYPE`，导致保存配置时抛出`ClassCastException`。

### 修复方案
在每个`ModelField`子类的构造函数中**强制设置**`valueType`：

```kotlin
// BooleanModelField
class BooleanModelField(...) : ModelField<Boolean>(...) {
    init {
        valueType = Boolean::class.java  // 强制设置
    }
}

// IntegerModelField & ChoiceModelField
constructor(...) : super(...) {
    valueType = Int::class.java
}

// SelectModelField & SelectAndCountModelField  
constructor(...) : super(...) {
    valueType = value.javaClass
}
```

### 修复的文件
- `BooleanModelField.kt` - 添加init块
- `IntegerModelField.kt` - 所有构造函数添加类型设置
- `ChoiceModelField.kt` - 所有构造函数添加类型设置
- `SelectModelField.kt` - 所有构造函数添加类型设置
- `SelectAndCountModelField.kt` - 所有构造函数添加类型设置

## 📞 联系支持
如果按照以上步骤仍然无法解决，请提供：
1. `error.log`完整内容
2. `runtime.log`中的版本号信息
3. 手机型号和系统版本
4. LSPosed版本号
