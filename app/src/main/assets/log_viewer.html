<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Log Viewer</title>
    <style>
        :root {
          --bg: #0b0b0c;
          --fg: #e6e6e6;
          --muted: #9aa0a6;
        }
        @media (prefers-color-scheme: light) {
          :root {
            --bg: #ffffff;
            --fg: #1f1f1f;
            --muted: #666;
          }
        }
        html, body {
          margin: 0;
          padding: 0;
          background: var(--bg);
          color: var(--fg);
          font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
          line-height: 1.4;
          -webkit-text-size-adjust: 100%;
        }
        #toolbar {
          position: sticky;
          top: 0;
          background: rgba(0,0,0,0.08);
          backdrop-filter: blur(4px);
          border-bottom: 1px solid rgba(255,255,255,0.08);
          z-index: 10;
        }
        .toolbar-row {
          padding: 8px 12px;
          display: flex;
          gap: 12px;
          align-items: center;
        }
        .toolbar-row:not(:last-child) {
          border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        #filterInput {
          flex: 1;
          padding: 4px 10px;
          border: 1px solid rgba(255,255,255,0.15);
          border-radius: 6px;
          background: transparent;
          color: var(--fg);
          font-size: 12px;
        }
        #log {
          white-space: pre-wrap;      /* 自动换行，保留换行符 */
          word-break: break-word;
          padding: 8px 8px 8px 8px;
          font-size: 11px;
          line-height: 1.6;           /* 行间距更舒适 */
        }
        button, label {
          color: var(--fg);
          background: transparent;
          border: 1px solid rgba(255,255,255,0.15);
          padding: 4px 10px;
          border-radius: 6px;
          font-size: 12px;
        }
        button:hover { border-color: rgba(255,255,255,0.3); }
        .muted { color: var(--muted); font-size: 12px; margin-left: auto; }
        input[type="checkbox"] { vertical-align: middle; }
    </style>
</head>
<body>
<div id="toolbar">
    <!-- 第一行：基础功能 -->
    <div class="toolbar-row">
        <label><input type="checkbox" id="autoScroll" checked /> 自动滚动到底部</label>
        <button onclick="clearLog()">清空显示</button>
        <span class="muted" id="status">就绪</span>
    </div>
    <!-- 第二行：筛选功能 -->
    <div class="toolbar-row">
        <input type="text" id="filterInput" placeholder="输入关键字实时筛选..." />
        <button onclick="clearFilter()">清除筛选</button>
        <span class="muted" id="filterStats"></span>
    </div>
</div>

<div id="loadingIndicator" style="display: none; text-align: center; padding: 10px; color: var(--muted);">
    ⏳ 正在加载更多...
</div>
<div id="log"></div>

<script>
    const logEl = document.getElementById('log');
    const autoScrollEl = document.getElementById('autoScroll');
    const statusEl = document.getElementById('status');
    const filterInputEl = document.getElementById('filterInput');
    const filterStatsEl = document.getElementById('filterStats');
    const loadingIndicator = document.getElementById('loadingIndicator');

    let fullLogText = ''; // 保存完整的日志内容
    let currentFilter = ''; // 当前筛选关键字
    let filterDebounceTimer = null; // 防抖计时器
    
    // 懒加载相关
    let isLoading = false;  // 是否正在加载
    let hasMoreData = true; // 是否还有更多数据
    let totalAvailable = 0; // 总可用行数
    let currentLoaded = 0;  // 当前已加载行数
    let lineHeight = 0;     // 平均每行高度（自动计算）
    let visibleLines = 0;   // 可视区域可显示的行数
    let loadLinesPerBatch = 500; // 每批次加载行数（自适应）
    
    // 后台预加载相关
    let isPreloading = false;   // 是否正在后台预加载
    let preloadTimer = null;    // 预加载定时器
    let preloadStartTime = 0;   // 预加载开始时间
    let wasPreloading = false;  // 是否曾被暂停（用于恢复）
    let resumeTimer = null;     // 恢复预加载定时器
    
    // 🔧 懒加载常量配置
    const ESTIMATED_LINE_HEIGHT = 18;  // 预估行高（px）= 11px字体 × 1.6行高
  
    const SCROLL_THRESHOLD = 300;      // 触发加载的距离顶部阈值（px）
    const SCREEN_MULTIPLIER = 5;       // 加载屏数倍数（5屏数据）

    const MIN_LOAD_LINES = 200;        // 最小加载行数

    const DEBOUNCE_SCROLL = 150;       // 滚动防抖延迟（ms）
    const DEBOUNCE_FILTER = 500;       // 筛选防抖延迟（ms）
    
    const PRELOAD_DELAY = 10000;       // 预加载延迟（ms）：初始加载完10秒后开始
    const PRELOAD_BATCH = 500;         // 预加载批次大小（行）
    const PRELOAD_INTERVAL = 500;      // 预加载间隔（ms）：每批间隔0.5秒
 

    function _scrollToBottom() {
      if (!autoScrollEl.checked) return;
      window.scrollTo(0, document.body.scrollHeight);
    }

    // 供原生调用：全量替换
    function setFullText(text) {
      fullLogText = text || '';
      if (currentFilter) {
        applyFilter();
      } else {
        logEl.textContent = fullLogText;
        statusEl.textContent = '已加载 ' + (fullLogText ? fullLogText.length : 0) + ' 字节';
      }
      // 注意：不自动滚动，由 onInitialLoadComplete 统一处理
    }

    // 供原生调用：增量追加
    function appendLog(chunk) {
      if (!chunk) return;
      
      // 🛑 暂停后台预加载（避免与追加冲突）
      if (isPreloading) {
        if (preloadTimer) {
          clearTimeout(preloadTimer);
          preloadTimer = null;
        }
        wasPreloading = true;  // 标记曾被暂停
        isPreloading = false;
        console.log('⏸️ 暂停预加载（新日志追加中）');
      }
      
      fullLogText += chunk;
      if (currentFilter) {
        // 筛选模式下：只追加包含关键字的行
        const newLines = chunk.split('\n');
        const filtered = newLines.filter(line => line.includes(currentFilter));
        if (filtered.length > 0) {
          logEl.textContent += (logEl.textContent ? '\n' : '') + filtered.join('\n');
          statusEl.textContent = '追加 ' + filtered.length + ' 条匹配记录';
        }
      } else {
        logEl.textContent += chunk;
        statusEl.textContent = '追加 ' + chunk.length + ' 字节';
      }
      _scrollToBottom();
      
      // 🔄 追加完成后，延迟恢复预加载（2秒无新追加则恢复）
      scheduleResumePreload();
    }

    // 供原生调用：批量追加行（Flow 流式加载专用）
    function appendLines(lines) {
      if (!lines || lines.length === 0) return;
      
      // 🛑 暂停后台预加载（避免与追加冲突）
      if (isPreloading) {
        if (preloadTimer) {
          clearTimeout(preloadTimer);
          preloadTimer = null;
        }
        wasPreloading = true;  // 标记曾被暂停
        isPreloading = false;
        console.log('⏸️ 暂停预加载（批量追加中）');
      }
      
      const chunk = lines.join('\n') + '\n';
      fullLogText += chunk;
      
      if (currentFilter) {
        // 筛选模式下：只追加包含关键字的行
        const filtered = lines.filter(line => line.includes(currentFilter));
        if (filtered.length > 0) {
          logEl.textContent += (logEl.textContent ? '\n' : '') + filtered.join('\n');
          statusEl.textContent = '追加 ' + filtered.length + ' 条匹配记录';
        }
      } else {
        // 使用 DocumentFragment 优化 DOM 操作性能
        const text = logEl.textContent;
        logEl.textContent = text + (text && !text.endsWith('\n') ? '\n' : '') + lines.join('\n');
        statusEl.textContent = '已加载 ' + lines.length + ' 行';
      }
      // 注意：初始加载时不自动滚动，避免干扰用户操作
      
      // 🔄 批量追加完成后，延迟恢复预加载
      scheduleResumePreload();
    }

    // 清空显示（不影响原文件，仅清 UI）
    function clearLog() {
      fullLogText = '';
      logEl.textContent = '';
      statusEl.textContent = '已清空显示';
    }

    // 应用筛选 (优化版：支持倒排索引加速)
    function applyFilter(keyword) {
      // 如果没有传入关键词，从输入框获取
      if (keyword === undefined) {
        keyword = filterInputEl.value.trim();
      }
      
      if (!keyword) {
        clearFilter();
        return;
      }

      currentFilter = keyword;
      statusEl.textContent = '正在筛选...';
      filterStatsEl.textContent = '';

      // 优先使用后端搜索（支持完整日志搜索）
      if (window.SearchBridge && window.SearchBridge.searchLines) {
        try {
          const resultJson = window.SearchBridge.searchLines(keyword);
          const result = JSON.parse(resultJson);
          
          if (result.lines && result.lines.length > 0) {
            logEl.textContent = result.lines.join('\n');
            statusEl.textContent = '就绪';
            const source = result.source === 'index' ? '索引' : '全文';
            filterStatsEl.textContent = '🔍 ' + result.total + ' 个结果 (' + source + '搜索)';
            _scrollToBottom();
            return;
          } else if (result.total === 0) {
            logEl.textContent = '';
            statusEl.textContent = '就绪';
            filterStatsEl.textContent = '🔍 未找到匹配结果';
            return;
          }
        } catch (e) {
          console.warn('后端搜索失败，回退到前端搜索:', e);
        }
      }

      // 回退到传统前端筛选方式
      setTimeout(() => {
        const lines = fullLogText.split('\n');
        const filtered = [];

        // 分批处理，避免一次性处理大量数据导致卡顿
        const batchSize = 1000;
        let processed = 0;

        function processBatch() {
          const end = Math.min(processed + batchSize, lines.length);
          for (let i = processed; i < end; i++) {
            if (lines[i].includes(keyword)) {
              filtered.push(lines[i]);
            }
          }
          processed = end;

          if (processed < lines.length) {
            statusEl.textContent = '筛选中: ' + Math.floor(processed / lines.length * 100) + '%';
            setTimeout(processBatch, 0);
          } else {
            // 完成筛选
            logEl.textContent = filtered.join('\n');
            statusEl.textContent = '就绪';
            filterStatsEl.textContent = filtered.length + '/' + lines.length + ' 行 (前端)';
            _scrollToBottom();
          }
        }

        processBatch();
      }, 10);
    }

    // 🚀 预计算初始加载量（在有数据前预估）
    function calculateInitialLoad() {
      const viewportHeight = window.innerHeight;
      const toolbarHeight = document.getElementById('toolbar')?.offsetHeight || 150;
      const availableHeight = viewportHeight - toolbarHeight - 50;
      
      const estimatedVisibleLines = Math.ceil(availableHeight / ESTIMATED_LINE_HEIGHT);
      const initialLoadCount = Math.max(estimatedVisibleLines * SCREEN_MULTIPLIER, MIN_LOAD_LINES);
      
      console.log('📱 预计算初始加载:');
      console.log('  - 屏幕高度:', viewportHeight, 'px');
      console.log('  - 可用高度:', availableHeight, 'px');
      console.log('  - 预估行数:', estimatedVisibleLines);
      console.log('  - 初始加载:', initialLoadCount, '行');
      
      // 通知原生端
      if (window.SearchBridge && window.SearchBridge.setLoadBatchSize) {
        window.SearchBridge.setLoadBatchSize(initialLoadCount);
      }
      
      return initialLoadCount;
    }

    // 🔥 精确计算可视区域能显示多少行（有数据后）
    function calculateVisibleLines() {
      // 等待DOM渲染完成
      setTimeout(() => {
        // 计算平均行高
        const logLines = logEl.textContent.split('\n').filter(l => l.trim());
        if (logLines.length > 0) {
          const totalHeight = logEl.scrollHeight;
          lineHeight = totalHeight / logLines.length;
          
          // 计算可视区域高度
          const viewportHeight = window.innerHeight;
          const toolbarHeight = document.getElementById('toolbar').offsetHeight;
          const availableHeight = viewportHeight - toolbarHeight - 50;
          
          // 计算可视行数（加载指定屏数的数据）
          visibleLines = Math.ceil(availableHeight / lineHeight);
          loadLinesPerBatch = Math.max(visibleLines * SCREEN_MULTIPLIER, MIN_LOAD_LINES);
          
          console.log('📐 精确计算:');
          console.log('  - 实际行高:', lineHeight.toFixed(1), 'px');
          console.log('  - 可视区域:', availableHeight, 'px');
          console.log('  - 可视行数:', visibleLines);
          console.log('  - 每批次加载:', loadLinesPerBatch, '行');
          
          // 通知原生端调整批次大小
          if (window.SearchBridge && window.SearchBridge.setLoadBatchSize) {
            window.SearchBridge.setLoadBatchSize(loadLinesPerBatch);
          }
        }
      }, 100);
    }

    // 初始加载完成回调（由原生端调用）
    function onInitialLoadComplete(keywordCount, loaded, total, hasMore) {
      console.log('📑 初始加载完成:', loaded, '/', total, '行');
      
      currentLoaded = loaded;
      totalAvailable = total;
      hasMoreData = hasMore;
      
      // 计算自适应行数
      calculateVisibleLines();
      
      // 更新状态显示
      if (hasMore) {
        statusEl.textContent = '已加载 ' + loaded + '/' + total + ' 行 (往上滑动加载更多)';
      } else {
        statusEl.textContent = '已加载全部 ' + total + ' 行';
      }
      
      // 如果索引还未构建，显示提示
      if (keywordCount === 0) {
        statusEl.textContent += ' | ⏳ 索引构建中...';
      }
      
      // 初始加载完成后，自动滚动到底部（查看最新日志）
      setTimeout(() => {
        window.scrollTo(0, document.body.scrollHeight);
      }, 100);
      
      // 🔥 如果还有更多数据，10秒后启动后台预加载
      if (hasMore) {
        console.log('⏰ 将在', PRELOAD_DELAY/1000, '秒后开始后台预加载');
        preloadTimer = setTimeout(() => {
          startBackgroundPreload();
        }, PRELOAD_DELAY);
      }
    }

    // 索引构建完成回调（由原生端调用）
    function onIndexBuilt(keywordCount) {
      console.log('🔍 索引构建完成:', keywordCount, '个关键词');
      
      // 更新状态显示
      if (hasMoreData) {
        statusEl.textContent = '已加载 ' + currentLoaded + '/' + totalAvailable + ' 行 (往上滑动加载更多) | 🔍 ' + keywordCount + ' 个关键词';
      } else {
        statusEl.textContent = '已加载全部 ' + totalAvailable + ' 行 | 🔍 ' + keywordCount + ' 个关键词';
      }
    }

    // 🔥 加载更多数据
    function loadMoreData() {
      if (isLoading) {
        return;
      }
      
      // 🔥 检查是否从 fullLogText 加载（预加载完成但 DOM 未完全更新）
      // 使用字符长度判断更准确
      const fullTextLength = fullLogText.length;
      const displayedTextLength = logEl.textContent.length;
      
      if (fullTextLength > displayedTextLength && fullTextLength > 0) {
        // 从 fullLogText 加载未显示的部分
        isLoading = true;
        loadingIndicator.style.display = 'block';
        statusEl.textContent = '正在加载更多...';
        
        try {
          const fullLogLines = fullLogText.split('\n').filter(line => line !== '');
          const displayedLines = logEl.textContent.split('\n').filter(line => line !== '');
          const notDisplayedCount = fullLogLines.length - displayedLines.length;
          
          if (notDisplayedCount > 0) {
            const loadCount = Math.min(loadLinesPerBatch, notDisplayedCount);
            const startIndex = fullLogLines.length - displayedLines.length - loadCount;
            const endIndex = fullLogLines.length - displayedLines.length;
            const moreLines = fullLogLines.slice(startIndex, endIndex);
            
            if (moreLines.length > 0) {
              const scrollBefore = window.scrollY;
              const heightBefore = document.body.scrollHeight;
              
              const newText = moreLines.join('\n') + '\n';
              logEl.textContent = newText + logEl.textContent;
              
              const heightAfter = document.body.scrollHeight;
              const heightDiff = heightAfter - heightBefore;
              window.scrollTo(0, scrollBefore + heightDiff);
              
              const hasMore = notDisplayedCount > loadCount;
              if (hasMore) {
                statusEl.textContent = '已加载 (还有更多，继续往上滑动)';
              } else {
                statusEl.textContent = '已加载全部 ' + currentLoaded + ' 行';
              }
              
              console.log('📄 从内存加载更多:', moreLines.length, '行，剩余:', notDisplayedCount - loadCount);
            }
          }
        } catch (e) {
          console.error('❌ 从内存加载失败:', e);
          console.error('错误堆栈:', e.stack);
          statusEl.textContent = '加载失败: ' + e.message;
        } finally {
          isLoading = false;
          setTimeout(() => {
            loadingIndicator.style.display = 'none';
          }, 500);
        }
        return;
      }
      
      // 否则从后端加载
      if (!hasMoreData) {
        return;
      }
      
      if (!window.SearchBridge) {
        console.error('❌ SearchBridge 未初始化');
        statusEl.textContent = '加载失败: 接口未就绪';
        return;
      }
      
      isLoading = true;
      loadingIndicator.style.display = 'block'; // 显示加载指示器
      statusEl.textContent = '正在加载更多...';
      
      try {
        // 调用原生方法加载更多（使用自适应行数）
        console.log('🔄 请求加载更多:', loadLinesPerBatch, '行');
        const jsonResult = window.SearchBridge.loadMore(loadLinesPerBatch);
        console.log('📦 原生返回结果:', jsonResult);
        
        const moreLines = JSON.parse(jsonResult);
        
        if (moreLines && moreLines.length > 0) {
          // 记录当前滚动位置
          const scrollBefore = window.scrollY;
          const heightBefore = document.body.scrollHeight;
          
          // 在顶部插入新数据
          const newText = moreLines.join('\n') + '\n';
          fullLogText = newText + fullLogText;
          
          // 🔍 如果处于筛选状态，只显示匹配的行
          if (currentFilter) {
            const filteredLines = moreLines.filter(line => line.includes(currentFilter));
            if (filteredLines.length > 0) {
              const filteredText = filteredLines.join('\n') + '\n';
              logEl.textContent = filteredText + logEl.textContent;
            }
            // 如果没有匹配的行，不添加任何内容到显示区域
          } else {
            // 正常模式：显示所有行
            logEl.textContent = newText + logEl.textContent;
          }
          
          // 恢复滚动位置（保持用户当前视图）
          const heightAfter = document.body.scrollHeight;
          const heightDiff = heightAfter - heightBefore;
          window.scrollTo(0, scrollBefore + heightDiff);
          
          currentLoaded += moreLines.length;
          
          // 检查是否还有更多
          hasMoreData = window.SearchBridge.hasMore();
          
          if (hasMoreData) {
            const displayText = currentFilter ? '(筛选中) 继续往上滑动' : '继续往上滑动';
            statusEl.textContent = '已加载 ' + currentLoaded + '/' + totalAvailable + ' 行 (' + displayText + ')';
          } else {
            statusEl.textContent = '已加载全部 ' + currentLoaded + ' 行';
            loadingIndicator.textContent = '✅ 已加载全部日志';
          }
          
          console.log('📄 加载更多成功:', moreLines.length, '行');
        } else {
          hasMoreData = false;
          statusEl.textContent = '没有更多日志';
          loadingIndicator.textContent = '✅ 已加载全部';
          console.log('✅ 已加载全部日志');
        }
      } catch (e) {
        console.error('❌ 加载更多失败:', e);
        console.error('错误堆栈:', e.stack);
        statusEl.textContent = '加载失败: ' + e.message;
        loadingIndicator.textContent = '❌ 加载失败';
      } finally {
        isLoading = false;
        // 延迟隐藏加载指示器
        setTimeout(() => {
          if (!hasMoreData || loadingIndicator.textContent.includes('✅') || loadingIndicator.textContent.includes('❌')) {
            // 如果已全部加载或有错误，保持显示
          } else {
            loadingIndicator.style.display = 'none';
          }
        }, 500);
      }
    }

    // 监听滚动事件，触底加载
    let scrollDebounceTimer = null;
    window.addEventListener('scroll', function() {
      if (scrollDebounceTimer) {
        clearTimeout(scrollDebounceTimer);
      }
      
      scrollDebounceTimer = setTimeout(() => {
        // 检测是否滚动到顶部（或接近顶部）
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        
        if (scrollTop < SCROLL_THRESHOLD && hasMoreData && !isLoading) {
          // 如果用户主动滚动到顶部，暂停后台预加载，改为立即加载
          if (preloadTimer) {
            clearTimeout(preloadTimer);
            preloadTimer = null;
          }
          isPreloading = false;
          
          loadMoreData();
        }
      }, DEBOUNCE_SCROLL);
    });

    // 🔄 计划恢复预加载（追加停止2秒后）
    function scheduleResumePreload() {
      // 清除之前的恢复定时器
      if (resumeTimer) {
        clearTimeout(resumeTimer);
        resumeTimer = null;
      }
      
      // 只有曾被暂停且还有数据时才恢复
      if (!wasPreloading || !hasMoreData) {
        return;
      }
      
      // 2秒无新追加则恢复预加载
      resumeTimer = setTimeout(() => {
        if (wasPreloading && !isPreloading && hasMoreData) {
          console.log('▶️ 恢复后台预加载...');
          wasPreloading = false;
          startBackgroundPreload();
        }
      }, 3000);
    }

    // 🚀 启动后台预加载
    function startBackgroundPreload() {
      if (isPreloading || !hasMoreData) {
        return;
      }
      
      console.log('🔄 开始后台预加载剩余日志...');
      preloadStartTime = Date.now(); // 记录开始时间
      isPreloading = true;
      wasPreloading = false;  // 清除暂停标记
      backgroundPreloadNext();
    }
    
    // 📦 后台预加载下一批
    function backgroundPreloadNext() {
      if (!hasMoreData || isLoading) {
        if (!hasMoreData) {
          // 计算耗时
          const loadTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
          console.log('✅ 后台预加载完成，耗时:', loadTime, '秒');
          isPreloading = false;
          statusEl.textContent = '已加载全部 ' + currentLoaded + ' 行 (用时' + loadTime + '秒)';
        }
        return;
      }
      
      try {
        const jsonResult = window.SearchBridge.loadMore(PRELOAD_BATCH);
        const moreLines = JSON.parse(jsonResult);
        
        if (moreLines && moreLines.length > 0) {
          // 🚀 只更新数据，不更新 DOM（性能优化）
          const newText = moreLines.join('\n') + '\n';
          fullLogText = newText + fullLogText;
          // ❌ 移除 DOM 更新：logEl.textContent = newText + logEl.textContent;
          
          currentLoaded += moreLines.length;
          hasMoreData = window.SearchBridge.hasMore();
          
          // 更新状态：显示已加载行数和已用时间
          const elapsedTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
          const remaining = totalAvailable - currentLoaded;
          const percent = Math.floor((currentLoaded / totalAvailable) * 100);
          statusEl.textContent = '已加载 ' + currentLoaded + '/' + totalAvailable + ' 行 (' + percent + '%) | 后台加载中 (' + elapsedTime + '秒)';
          
          console.log('📦 后台预加载: +' + moreLines.length + ' 行 (' + currentLoaded + '/' + totalAvailable + ')');
          
          // 继续下一批（间隔加载）
          if (hasMoreData) {
            preloadTimer = setTimeout(() => {
              backgroundPreloadNext();
            }, PRELOAD_INTERVAL);
          } else {
            // 计算耗时
            const loadTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
            isPreloading = false;
            statusEl.textContent = '已加载全部 ' + currentLoaded + ' 行 (用时' + loadTime + '秒)';
            console.log('✅ 所有日志已加载完成，耗时:', loadTime, '秒');
          }
        } else {
          hasMoreData = false;
          isPreloading = false;
          // 计算耗时
          const loadTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
          statusEl.textContent = '已加载全部 ' + currentLoaded + ' 行 (用时' + loadTime + '秒)';
        }
      } catch (e) {
        console.error('❌ 后台预加载失败:', e);
        isPreloading = false;
      }
    }

    // 清除筛选
    function clearFilter() {
      currentFilter = '';
      filterInputEl.value = '';
      logEl.textContent = fullLogText;
      statusEl.textContent = '就绪';
      filterStatsEl.textContent = '';
      _scrollToBottom();
    }

    // 🚀 加载全部并跳到顶部（供后端调用）
    function loadAllAndScrollToTop() {
      console.log('🔝 请求跳到顶部...');
      
      // 1. 检查是否所有数据都已显示
      const fullTextLength = fullLogText.length;
      const displayedTextLength = logEl.textContent.length;
      
      if (fullTextLength > displayedTextLength && fullTextLength > 0) {
        // 有未显示的数据，先全部加载到 DOM
        console.log('📦 加载剩余数据到 DOM...');
        statusEl.textContent = '正在加载全部日志...';
        
        try {
          const fullLogLines = fullLogText.split('\n').filter(line => line !== '');
          const displayedLines = logEl.textContent.split('\n').filter(line => line !== '');
          const notDisplayedCount = fullLogLines.length - displayedLines.length;
          
          if (notDisplayedCount > 0) {
            // 一次性加载所有未显示的行
            const startIndex = 0;
            const endIndex = fullLogLines.length - displayedLines.length;
            const moreLines = fullLogLines.slice(startIndex, endIndex);
            
            if (moreLines.length > 0) {
              const newText = moreLines.join('\n') + '\n';
              logEl.textContent = newText + logEl.textContent;
              
              console.log('✅ 已加载全部数据:', moreLines.length, '行');
              statusEl.textContent = '已加载全部 ' + fullLogLines.length + ' 行';
            }
          }
        } catch (e) {
          console.error('❌ 加载全部数据失败:', e);
        }
      }
      
      // 2. 滚动到顶部
      setTimeout(() => {
        window.scrollTo(0, 0);
        console.log('✅ 已滚动到第一行');
      }, 100);
    }

    // 🔥 实时筛选：输入时自动筛选（带防抖优化）
    filterInputEl.addEventListener('input', function(e) {
      const keyword = e.target.value.trim();
      
      // 清除之前的定时器
      if (filterDebounceTimer) {
        clearTimeout(filterDebounceTimer);
      }
      
      // 如果输入为空，立即清除筛选
      if (!keyword) {
        clearFilter();
        return;
      }
      
      // 防抖：延迟后执行筛选（避免频繁触发）
      filterDebounceTimer = setTimeout(() => {
        applyFilter(keyword);
      }, DEBOUNCE_FILTER);
    });

    // 📱 监听窗口大小变化（屏幕旋转、窗口调整）
    let resizeTimer = null;
    window.addEventListener('resize', function() {
      if (resizeTimer) {
        clearTimeout(resizeTimer);
      }
      
      resizeTimer = setTimeout(() => {
        if (currentLoaded > 0) {
          calculateVisibleLines();
          console.log('📱 窗口调整，重新计算自适应行数');
        }
      }, 300);
    });

</script>
</body>
</html>
